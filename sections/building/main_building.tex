% !TEX program = lualatex
\documentclass[../../main.tex]{subfiles}
\begin{document}

\section{Building}%
\label{sec:building}

A preliminary examination of using yocto versus using the mender-convert utility can be seen
in table \ref{tab:build_comp}. For reference the raspbian buster lite image is approximately
1.8GB in size.

The table clearly shows that building an image using yocto with sstate caching is far superior
in build time and image size, at the expense of a bit more setup time compared to the
mender-convert utility.

What is not shown here is that with yocto all source code for the build is downloaded so it
requires more disk space from the build system.

Sstate caching is yocto genrating a cache of the compiled binaries, so as long no major
architechtual changes take place there is no need to recompile a lot of binaries.


\begin{table}[h]
	\centering
	\caption{
		Build comparison of the default mender raspberrypi yocto build and a mender-convert build
		of the default raspbian buster light image.
	}
	\label{tab:build_comp}
	\begin{tabular}{l|ccc}
		& \textbf{Yocto with sstate caching}& \textbf{Yocto} & \textbf{Mender-convert}\\
		\hline
		\textbf{Build time}&3m43.789s&83m11.750s& $\sim$ 20m \\
		\textbf{Image size}&604MB&604MB&7.67GB\\
	\end{tabular}
\end{table}


%For creating images mender offers 2 possibilities.
%The first is to user the mender-convert utility, which converts a debian image
%to one with mender support. This approach has little influence on any workflow which relies
%on generating a debian image.\\

Using the yocto project also has the great advantage of having huge community behind it, with support for many different embedded boards which should make future hardware migrationse easier.

Committing to mender and the yocto project does increase the requirement to follow upstream
yocto layers and update the yocto build to be compliant with upstream yocto.

To properly understand the advantages and disadvantages of using yocto, here is a short introduction.

\subsection{Yocto}%
\label{sub:yocto}

Yocto is build system for creating linux distributions for embedded devices. It relies on meta-layers
each modifying the resulting image. These meta-layers can contain board specific settings,
applications, modifications to other layers and so forth.

The primary files in a meta-layer are bitbake files with the extension .bb and .bbappend files.

These files follow a strict naming convention in the form of
\texttt{\{name\}\_\{version\}.\{bb|bbappend\}}.\\

A layer refers to a set of recipes



%\subsubsection{Syntax}%
%\label{ssub:syntax}
%
%Variables can be initialised in 3 ways see listing \ref{lst:bb_initialisers}.
%\begin{listing}[h]
%\begin{minted}{bitbake}
%# super weak initialiser
%VAR ??= "1" 
%# weak initialiser
%VAR  ?= "2" 
%# normal initialiser
%VAR   = "3" 
%\end{minted}
%\caption{Initialisers in bb files.}
%\label{lst:bb_initialisers}
%\end{listing}
%
%
%Functions take the form \mintinline{bitbake}|do_compile(){}| and a standard bb recipe contain
%the default functions \mintinline{bitbake}|do_configure(){}|, \mintinline{bitbake}|do_compile(){}|
%and \mintinline{bitbake}|do_install(){}|.\\
%
%A function can either be invoked inside a task or it can be promoted to a task and injected into 
%the task chain.
%
%Function can be written in shell or python.

\subsubsection{Software setup}%
\label{ssub:software_setup}
\subfile{setup.tex}


\subsubsection{Migrating to yocto}%
\label{ssub:migrating_to_yocto}
\subfile{migration.tex}


%\subsubsection{Layers}%
%\label{ssub:layers}
%
%The default layers for mender-raspberrypi
%\begin{itemize}
%	\item meta-poky
%	\item meta-yocto-bsp
%	\item meta-oe
%	\item meta-python
%	\item meta-networking
%	\item meta-multimedia
%	\item meta-raspberrypi
%	\item meta-mender-core
%	\item meta-mender-raspberrypi
%	\item meta-mclurs
%\end{itemize}
%Though it should build without the mender demo layer.


\end{document}
